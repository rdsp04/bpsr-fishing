<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <script src="https://kit.fontawesome.com/fc0cae2ea4.js"
      crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Viga&display=swap"
      rel="stylesheet">
    <title>Fisher Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

        html {
        overflow: hidden;
        }

        body {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow-y: scroll;
        background-color: #111;
        font-family: 'Viga', sans-serif !important;

        }
        #app {
        height: auto;
        overflow: visible;
        }

        body::-webkit-scrollbar {
        width: 8px;
        }

        body::-webkit-scrollbar-thumb {
        background: #0284C7;
        border-radius: 4px;
        }

        body::-webkit-scrollbar-thumb:hover {
        background: #0369A1;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #222;
        }

        th {
            background-color: #1a1a1a;
        }

        td {
            background-color: #111;
        }

        select {
            background-color: #222;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;

        }

        label {
            display: block;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }

        button {
            cursor: pointer;
        }

        @keyframes bounce {
        0%, 100% {
        transform: translateY(-50%);
        animation-timing-function: cubic-bezier(0.5, 0, 1, 1);
        }
        50% {
        transform: none;
        animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
        }

    </style>
  </head>

  <body class="text-white font-sans p-4">

    <div id="app">

      <div class="px-4 flex items-center justify-center gap-2">
        <h1 class="text-5xl font-bold text-center mb-4">BPSR FISHING</h1>
        <img class="h-32 w-32"
          src="https://assets-ng.maxroll.gg/sr-tools/assets/db/icons/items/miscellaneous/item_icons_fishbait04.webp"
          alt="Icon">
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 mb-4 place-content-center font-bold text-xl">
        <button id="tab-daily"
          class="px-4 py-2 bg-sky-600 rounded-full hover:bg-sky-700 hover:animate-bounce"><i
            class="fa-solid fa-scroll"></i> Daily Stats</button>
        <button id="tab-summary"
          class="px-4 py-2 bg-sky-600 rounded-full hover:bg-sky-700 hover:animate-bounce"><i
            class="fa-solid fa-fish-fins"></i> Summary</button>
        <button id="tab-settings"
          class="px-4 py-2 bg-sky-600 rounded-full hover:bg-sky-700 hover:animate-bounce"><i
            class="fa-solid fa-gears"></i> Settings</button>
        <button id="btn-refresh"
          class="px-4 py-2 bg-sky-600 rounded-full hover:bg-sky-700 hover:animate-bounce"><i
            class="fa-solid fa-bug"></i> Refresh</button>
      </div>

      <!-- Pages -->
      <div id="page-daily" class="space-y-6 overflow-auto max-h-[80vh]">
        <div id="daily-tables"></div>
      </div>

      <div id="page-summary"
        class="space-y-6 overflow-auto max-h-[80vh] hidden">
        <div id="summary-tables"></div>
      </div>

      <div id="page-settings"
        class="space-y-6 overflow-auto max-h-[80vh] hidden">

        <h2 class="text-xl font-bold">Display</h2>

        <div>
          <label for="resolution">Resolution</label>
          <select id="resolution">
            <option value="1920x1080">1920x1080</option>
          </select>
        </div>

        <h2 class="text-xl font-bold">Preferences</h2>
        <br>
        <span class="text-sm px-1.5 py-1 bg-red-600 rounded-full"><i
            class="fa-solid fa-triangle-exclamation"></i> Coming Soon <i
            class="fa-solid fa-triangle-exclamation"></i></span>

        <div>
          <label for="auto-bait">Auto Bait Purchase</label>
          <select id="auto-bait" disabled>
            <option value="T1" selected>T1</option>
            <option value="T2">T2</option>
            <option value="T3">T3</option>
          </select>
        </div>

        <div>
          <label for="auto-rods">Auto Rods Purchase</label>
          <select id="auto-rods" disabled>
            <option value="T1" selected>T1</option>
            <option value="T2">T2</option>
            <option value="T3">T3</option>
          </select>
        </div>
        <div>
          <label>Start Keybind</label>
          <button id="start_key-btn"
            class="rounded w-20 h-10 border border-gray-500 bg-[rgba(255,255,255,0.1)] focus:outline-none">/</button>
        </div>

        <div>
          <label>Stop Keybind</label>
          <button id="stop_key-btn"
            class="rounded w-20 h-10 border border-gray-500 bg-[rgba(255,255,255,0.1)] focus:outline-none">.</button>
        </div>

        <div>
          <label>Fish Key</label>
          <button id="fish_key-btn"
            class="rounded w-20 h-10 border border-gray-500 bg-[rgba(255,255,255,0.1)] focus:outline-none">F</button>
        </div>

        <div>
          <label>Bait Key</label>
          <button id="bait_key-btn"
            class="rounded w-20 h-10 border border-gray-500 bg-[rgba(255,255,255,0.1)] focus:outline-none">N</button>
        </div>

        <div>
          <label>Rods Key</label>
          <button id="rods_key-btn"
            class="rounded w-20 h-10 border border-gray-500 bg-[rgba(255,255,255,0.1)] focus:outline-none">M</button>
        </div>

        <div>
          <label>Escape Key</label>
          <button id="esc_key-btn"
            class="rounded w-20 h-10 border border-gray-500 bg-[rgba(255,255,255,0.1)] focus:outline-none">ESC</button>
        </div>

      </div>
    </div>

    <script>
        const allKeys = [
          'A','B','C','D','E','F','G','H','I','J','K','L','M',
          'N','O','P','Q','R','S','T','U','V','W','X','Y','Z',
          '0','1','2','3','4','5','6','7','8','9',
          'F1','F2','F3','F4','F5','F6','F7','F8','F9','F10','F11','F12',
          'ESC','TAB','CAPSLOCK','SHIFT','CTRL','ALT','SPACE','ENTER','BACKSPACE',
          'INSERT','DELETE','HOME','END','PAGEUP','PAGEDOWN','LEFT','UP','RIGHT','DOWN',
          '`','-','=','[',']','\\',';','\'',',','.','/','~','!','@','#','$','%','^','&','*','(',')','_','+','{','}','|',':','"','<','>','?'
        ];



        const dailyTab = document.getElementById('tab-daily');
        const summaryTab = document.getElementById('tab-summary');
        const settingsTab = document.getElementById('tab-settings');
        const refreshBtn = document.getElementById('btn-refresh');
        const dailyPage = document.getElementById('page-daily');
        const summaryPage = document.getElementById('page-summary');
        const settingsPage = document.getElementById('page-settings');

        async function loadDaily() {
            const dailyHtml = await window.pywebview.api.get_daily_table();
            document.getElementById('daily-tables').innerHTML = dailyHtml;
        }

        async function loadSummary() {
            const summaryHtml = await window.pywebview.api.get_overall_summary();
            document.getElementById('summary-tables').innerHTML = summaryHtml;
        }

        dailyTab.onclick = async () => {
            await loadDaily();
            dailyPage.classList.remove('hidden');
            summaryPage.classList.add('hidden');
            settingsPage.classList.add('hidden');
        };

        summaryTab.onclick = async () => {
            await loadSummary();
            dailyPage.classList.add('hidden');
            summaryPage.classList.remove('hidden');
            settingsPage.classList.add('hidden');
        };

        settingsTab.onclick = () => {
            dailyPage.classList.add('hidden');
            summaryPage.classList.add('hidden');
            settingsPage.classList.remove('hidden');
        };

        // Save settings when changed
        document.getElementById('resolution').onchange = async (e) => {
            await window.pywebview.api.set_resolution(e.target.value);
        };
        document.getElementById('auto-bait').onchange = async (e) => {
            await window.pywebview.api.set_auto_bait(e.target.value);
        };
        document.getElementById('auto-rods').onchange = async (e) => {
            await window.pywebview.api.set_auto_rod(e.target.value);
        };
        const keyButtons = [
            "start_key",
            "stop_key",
            "fish_key",
            "bait_key",
            "rods_key",
            "esc_key"
        ];

        async function initKeyButtons() {
            for (let keyName of keyButtons) {
                const btn = document.getElementById(`${keyName}-btn`);
                if (!btn) continue;

                // Load initial key from Python
                try {
                    const val = await window.pywebview.api.get_key(keyName);
                    btn.textContent = val || "Unset";
                } catch(err) {
                    console.error(`Failed to get key: ${keyName}`, err);
                    btn.textContent = "Unset"; // fallback
                }

                btn.onclick = async () => {
                    btn.classList.add("border-green-500"); // listening indicator

                    try {
                        const key = await window.pywebview.api.capture_key_for(keyName);
                        btn.textContent = key; // update to new key
                    } catch(err) {
                        console.error(`Failed to capture key: ${keyName}`, err);
                    } finally {
                        btn.classList.remove("border-green-500");
                    }
                };
            }
        }

        // Refresh button
        refreshBtn.onclick = async () => {
            await loadDaily();
            await loadSummary();
        };

        window.addEventListener('pywebviewready', async () => {
            await loadDaily();
            await loadSummary();
            await initKeyButtons();


            const res = await window.pywebview.api.get_resolution();
            document.getElementById('resolution').value = res;

            const bait = await window.pywebview.api.get_auto_bait();
            document.getElementById('auto-bait').value = bait;

            const rod = await window.pywebview.api.get_auto_rod();
            document.getElementById('auto-rods').value = rod;

            for (let k of keybinds) {
                const select = document.getElementById(k);
                if (!select) continue;

                select.innerHTML = '';
                allKeys.forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.text = key;
                    select.appendChild(opt);
                });

                try {
                    const val = await window.pywebview.api[`get_${k.replace('-', '_')}`]();
                    if (val) select.value = val.toUpperCase();
                } catch(err) {
                    console.error('Failed to get key', k, err);
                }

                select.onchange = async (e) => {
                    try {
                        await window.pywebview.api[`set_${k.replace('-', '_')}`](e.target.value);
                    } catch(err) {
                        console.error('Failed to set key', k, err);
                    }
                };
            }
        });

    </script>

  </body>

</html>
